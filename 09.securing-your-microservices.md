# Protegiendo tus microservicios

Pág. 240

---

Ahora que contamos con una arquitectura de microservicios robusta, la tarea de cubrir las vulnerabilidades de seguridad
se vuelve cada vez más esencial. En este capítulo, la seguridad y la vulnerabilidad van de la mano. **Definiremos
`vulnerabilidad` como una debilidad o falla presentada en una aplicación.** Por supuesto, todos los sistemas tienen
vulnerabilidades, pero la gran diferencia radica en si estas vulnerabilidades se explotan y causan daño.

Mencionar la seguridad a menudo provoca un gemido involuntario por parte de los desarrolladores. Entre los
desarrolladores escuchamos comentarios como: "Es obtuso, difícil de entender y aún más difícil de depurar". Sin embargo,
no encontraremos ningún desarrollador (excepto quizás un desarrollador sin experiencia) que diga que no se preocupa por
la seguridad. Proteger una arquitectura de microservicios es una tarea compleja y laboriosa que implica múltiples capas
de protección, incluidas las siguientes:

- `La capa de aplicación`: garantiza que existan los controles de usuario adecuados para que podamos validar que un
  usuario es quien dice ser y que tiene permiso para hacer lo que está intentando hacer.
- `Infraestructura`: mantiene el servicio en funcionamiento, parcheado y actualizado para minimizar el riesgo de
  vulnerabilidades.
- `Una capa de red`: implementa controles de acceso a la red para que solo se pueda acceder a un servicio a través de
  puertos bien definidos y solo para una pequeña cantidad de servidores autorizados.

Este capítulo solo cubre cómo autenticar y autorizar usuarios en nuestra `capa de aplicación` (el primer punto de la
lista). Los otros dos elementos son temas de seguridad extremadamente amplios que están fuera del alcance de este libro.
Además, existen otras herramientas, como el Proyecto OWASP Dependency-Check, que pueden ayudar a identificar
vulnerabilidades.

Para implementar controles de autorización y autenticación, usaremos el módulo `Spring Cloud Security` y `Keycloak` para
proteger nuestros servicios basados en Spring. `Keycloak` es un software de gestión de acceso e identidad de código
abierto para aplicaciones y servicios modernos. Este software de código abierto está escrito en Java y admite protocolos
de identidad federados SAML (Security Assertion Markup Language) v2 y OpenID Connect (OIDC)/OAuth2.

## 9.1 ¿Qué es OAuth2?

`OAuth2` es un marco de seguridad basado en tokens que describe patrones para otorgar autorización pero no define cómo
realizar realmente la autenticación. En cambio, permite a los usuarios autenticarse con un servicio de autenticación de
terceros, llamado `proveedor de identidad (IdP)`. Si el usuario se autentica correctamente, se le presenta un token que
debe enviarse con cada solicitud. Luego, el token se puede volver a validar en el servicio de autenticación.

El objetivo principal detrás de `OAuth2` es que cuando se llaman varios servicios para cumplir con la solicitud de un
usuario, cada servicio puede autenticar al usuario sin tener que presentar sus credenciales a cada servicio que procese
su solicitud. `OAuth2` nos permite proteger nuestros servicios basados en REST en diferentes escenarios mediante
esquemas de autenticación llamados concesiones `(grants)`. La especificación `OAuth2` tiene cuatro tipos de concesiones:

- Password
- Client credentials
- Authorization code
- Implicit

**NOTA**
> Actualmente `Implicit` y el `Password` son concesiones legacy, mientras que hay otras que han surgido como el
> `PKCE` que es similar al `Authorization Code`. Para más información visitar mi repositorio de
> [spring-security-in-action-2020](https://github.com/magadiflo/spring-security-in-action-2020/blob/main/12.1.oauth2_y_open-id-connect.md)

No vamos a analizar cada uno de estos tipos de subvenciones ni a proporcionar ejemplos de código para cada uno. Es
demasiado material para cubrirlo en un solo capítulo. En su lugar, haremos lo siguiente:

- Analice cómo nuestros microservicios pueden usar OAuth2 a través de uno de los tipos de concesión de OAuth2 más
  simples, el tipo de concesión de password.
- Utilice tokens web JSON (JWT) para proporcionar una solución OAuth2 más sólida y establecer un estándar para codificar
  información en un token OAuth2.
- Analice otras consideraciones de seguridad que deben tenerse en cuenta al crear microservicios.

**NOTA**
> Proporcionamos una descripción general de los otros tipos de concesiones de OAuth2 en el apéndice B. Si está
> interesado en profundizar en más detalles sobre la especificación de OAuth2 y cómo implementar todos los tipos de
> concesiones, le recomendamos encarecidamente el libro de Justin Richer y Antonio Sanso, OAuth2 en Action (Manning,
> 2017), que es una explicación completa de OAuth2.

El verdadero poder detrás de `OAuth2` es que permite a los desarrolladores de aplicaciones integrarse fácilmente con
proveedores de nube externos y autenticar y autorizar a los usuarios con esos servicios sin tener que pasar las
credenciales del usuario continuamente al servicio de terceros.

`OpenID Connect (OIDC)` es una capa encima del marco OAuth2 que proporciona autenticación e información de perfil sobre
quién ha iniciado sesión en la aplicación (la identidad). Cuando un servidor de autorización admite OIDC, a veces se le
denomina proveedor de identidad. Antes de entrar en los detalles técnicos de la protección de nuestros servicios,
repasemos la arquitectura de `Keycloak`.